#!/usr/bin/env bash

# Based on the Taskfile format from https://github.com/adriancooney/Taskfile
# Please keep functions sorted alphabetically for ease of editing.

# A useful path mod
PATH=./node_modules/.bin:$PATH

#######################################################################
# Set some commonly used globals
#######################################################################
BASE_DIR=$(cd `dirname $0`; pwd)
# As a security precaution, ensure the BASE_DIR is not empty, and that
# the path it refers to is writable by the current user.
if [ -z "$BASE_DIR" ] || [ ! -w "$BASE_DIR" ]; then
    echo "Error: BASE_DIR is not set or not writable: '$BASE_DIR'"
    exit 1
fi
# Target 3.13, fallback to 3.x, then python
BASE_PYTHON=`which python3.13 || which python3 || which python`
PROJECT_NAME=`basename "$BASE_DIR"`

# Some ANSI colors for pretty messages
NORMAL="$(tput sgr0)"
BLACK="$(tput setaf 0)"
RED="$(tput setaf 1)"
GREEN="$(tput setaf 2)"
YELLOW="$(tput setaf 3)"
BLUE="$(tput setaf 4)"
MAGENTA="$(tput setaf 5)"
CYAN="$(tput setaf 6)"
WHITE="$(tput setaf 7)"

#######################################################################
# Function declarations
#######################################################################

#######################################################################
function audit { ## Run code quality checks
    # See https://gohugo.io/troubleshooting/audit/
    HUGO_MINIFY_TDEWOLFF_HTML_KEEPCOMMENTS=true \
    HUGO_ENABLEMISSINGTRANSLATIONPLACEHOLDERS=true \
    hugo > .hugo_build.out 2> .hugo_build.err \
    --printI18nWarnings \
    --printPathWarnings \
    --printUnusedTemplates \
    --printMemoryUsage \
    --templateMetrics \
    --templateMetricsHints || { printf "%b %s\n" "${RED}✖${NORMAL}" "Hugo build failed!"; return 1; }

    # Search the generated public/ for known Hugo build warnings/markers.
    # Capture output (if any), print it, and save to a file when issues exist.
    issues=$(grep -inorE "<!-- raw HTML omitted -->|ZgotmplZ|\[i18n\]|\(<nil>\)|(&lt;nil&gt;)|hahahugo" public/ || true)

    if [ -z "${issues}" ]; then
        # No grep output -> success
        printf "%b %s\n" "${GREEN}✔${NORMAL}" "No issues detected"
        [ -f .hugo_build_issues.txt ] && rm -f .hugo_build_issues.txt
        return 0
    else
        # Print the issues to stdout and save to a file for later inspection
        echo "${issues}"
        echo "${issues}" > .hugo_build_issues.txt
        printf "%b %s\n" "${RED}✖${NORMAL}" "Build issues detected!"
        return 1
    fi
}

#######################################################################
function build { ## Build the static site (to public/)
    # Note: Django also uses /var/www/ for static files and media.
    # Building separately seems safer for now.
    hugo build --minify --cleanDestinationDir --gc --environment production
}

#######################################################################
function deploy { ## Deploy the site to the production server
    # Check the ownership of the var/www/ directory. If owner is not
    # the current user, use sudo to copy files as the owner.
    TARGET="$BASE_DIR/var/www/"
    OWNER=$(stat -c '%U' $TARGET)
    if [ "$OWNER" != "$USER" ]; then
        echo "Deploying site with sudo as $OWNER owns $TARGET"
        sudo -u "$OWNER" cp -r public/* $TARGET
    else
        echo "Deploying site to $TARGET as $USER"
        cp -r public/* $TARGET
    fi
}
#######################################################################
function help { ## Display usage for this application
    echo "$0 <task> <args>"
    echo "Tasks:"
    # compgen -A function | cat -n
    grep -E '^function [a-zA-Z_-]+ {.*?## .*$$' $0 | \
        sed -e 's/function //' | \
        sort | \
        awk 'BEGIN {FS = "{.*?## "}; {printf "\033[93m%-30s\033[92m %s\033[0m\n", $1, $2}'
    echo "VARIABLES:"
    echo "  BASE_DIR      : $BASE_DIR"
    echo "  BASE_PYTHON   : $BASE_PYTHON"
    echo "  PROJECT_NAME  : $PROJECT_NAME"
    echo ""
    echo "For production deployment, pull the desired branch from git, run 'build' then 'deploy'."
}

#######################################################################
function lighthouse { ## Audit the site for accessibility, SEO, performance, and best practices
    # If lighthouse executable is on the path, use it, otherwise check if npx is available
    REPORT="$BASE_DIR/var/lighthouse-report.html"
    if command -v lighthouse &> /dev/null; then
        lighthouse http://localhost:1313 --output html --output-path "$REPORT" --chrome-flags="--headless"
    elif command -v npx &> /dev/null; then
        npx lighthouse http://localhost:1313 --output html --output-path "$REPORT" --chrome-flags="--headless"
    else
        echo "Error: lighthouse or npx is not installed."
        exit 1
    fi
    echo "Lighthouse report generated at $REPORT"
}

#######################################################################
# Finally, execute it.
#######################################################################

TIMEFORMAT="Task completed in %3lR"
# Replace "help" with the name of the desired default function
time ${@:-help}
